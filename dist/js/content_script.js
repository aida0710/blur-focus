(()=>{"use strict";class t{injectStyles(e){const s=document.getElementById(t.STYLE_ID);s&&s.remove();const r=document.createElement("style");r.id=t.STYLE_ID,r.textContent=`\n      .${t.BLUR_CLASS} {\n        filter: blur(${e}px) !important;\n        transition: filter 0.2s ease !important;\n      }\n      .${t.BLUR_CLASS}.${t.HOVER_CLASS},\n      .${t.BLUR_CLASS}.${t.HOVER_CLASS} * {\n        filter: none !important;\n      }\n    `,document.head.appendChild(r)}removeStyles(){const e=document.getElementById(t.STYLE_ID);e&&e.remove()}applyBlurToElement(e){e.classList.contains(t.BLUR_CLASS)||e.classList.add(t.BLUR_CLASS)}removeBlurFromElement(e){e.classList.remove(t.BLUR_CLASS,t.HOVER_CLASS)}removeBlurFromAllElements(){document.querySelectorAll(`.${t.BLUR_CLASS}`).forEach(e=>{e.classList.remove(t.BLUR_CLASS,t.HOVER_CLASS)})}addHoverClass(e){e.classList.add(t.HOVER_CLASS)}removeHoverClass(e){e.classList.remove(t.HOVER_CLASS)}isBlurElement(e){return e.classList.contains(t.BLUR_CLASS)}static getBlurClassName(){return t.BLUR_CLASS}static getHoverClassName(){return t.HOVER_CLASS}}t.STYLE_ID="blur-focus-styles",t.BLUR_CLASS="blur-focus-element",t.HOVER_CLASS="blur-focus-hover";class e{constructor(t){this.hoveredElement=null,this.handleMouseOver=t=>{let e=t.target;const s=[];for(;e&&e!==document.body;)this.styleInjector.isBlurElement(e)&&s.push(e),e=e.parentElement;if(0===s.length)return;const r=s[0];if(this.hoveredElement!==r){if(this.hoveredElement){let t=this.hoveredElement;for(;t&&t!==document.body;)this.styleInjector.isBlurElement(t)&&this.styleInjector.removeHoverClass(t),t=t.parentElement}this.hoveredElement=r,s.forEach(t=>{this.styleInjector.addHoverClass(t)})}},this.handleMouseOut=t=>{const e=t.target,s=t.relatedTarget;if(!this.styleInjector.isBlurElement(e))return;if(this.hoveredElement!==e)return;if(s){if(e.contains(s))return;let t=s;for(;t&&t!==document.body;){if(this.styleInjector.isBlurElement(t))return;t=t.parentElement}}let r=this.hoveredElement;for(;r&&r!==document.body;)this.styleInjector.isBlurElement(r)&&this.styleInjector.removeHoverClass(r),r=r.parentElement;this.hoveredElement=null},this.styleInjector=t}setupEventListeners(){document.addEventListener("mouseover",this.handleMouseOver),document.addEventListener("mouseout",this.handleMouseOut)}removeEventListeners(){document.removeEventListener("mouseover",this.handleMouseOver),document.removeEventListener("mouseout",this.handleMouseOut)}}class s{constructor(t){this.observer=null,this.targetSelector="",this.styleInjector=t}start(t){this.targetSelector=t,this.observer=new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const e=t;e.matches&&e.matches(this.targetSelector)&&this.styleInjector.applyBlurToElement(e),e.querySelectorAll(this.targetSelector).forEach(t=>{this.styleInjector.applyBlurToElement(t)})}})})}),this.observer.observe(document.body,{childList:!0,subtree:!0})}stop(){this.observer&&(this.observer.disconnect(),this.observer=null)}updateTargetSelector(t){this.observer&&(this.stop(),this.start(t))}}const r={isBlur:!1,blurIntensity:5,targetElements:["h1","h2","h3","h4","h5","h6","p","a","span","ul","li","label","code"],siteList:[]};var n=function(t,e,s,r){return new(s||(s=Promise))(function(n,i){function o(t){try{a(r.next(t))}catch(t){i(t)}}function l(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,l)}a((r=r.apply(t,e||[])).next())})};class i{loadSettings(){return n(this,void 0,void 0,function*(){return new Promise((t,e)=>{chrome.storage.local.get(null,s=>{var n,i,o,l;if(chrome.runtime.lastError)return void e(chrome.runtime.lastError);const a={isBlur:null!==(n=s.isBlur)&&void 0!==n?n:r.isBlur,blurIntensity:null!==(i=s.blurIntensity)&&void 0!==i?i:r.blurIntensity,targetElements:null!==(o=s.targetElements)&&void 0!==o?o:r.targetElements,siteList:null!==(l=s.siteList)&&void 0!==l?l:r.siteList};t(a)})})})}saveSettings(t){return n(this,void 0,void 0,function*(){return new Promise((e,s)=>{chrome.storage.local.set(t,()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e()})})})}}function o(t,e){const s=e.replace(/\*/g,".*").replace(/\?/g,".");try{return new RegExp(s).test(t)}catch(t){return!1}}function l(t){if(0===t.length)return!0;const e=window.location.href,s=window.location.hostname;for(const r of t){const t=r.pattern;if(e.includes(t)||s.includes(t)||o(e,t))return r.enabled}return!0}var a=function(t,e,s,r){return new(s||(s=Promise))(function(n,i){function o(t){try{a(r.next(t))}catch(t){i(t)}}function l(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,l)}a((r=r.apply(t,e||[])).next())})};class c{constructor(){this.isActive=!1,this.targetSelector="",this.styleInjector=new t,this.eventHandler=new e(this.styleInjector),this.mutationHandler=new s(this.styleInjector),this.storageManager=new i,this.init()}init(){return a(this,void 0,void 0,function*(){try{if(console.log("[Blur Focus] 初期化開始"),yield this.loadSettings(),console.log("[Blur Focus] 設定読み込み完了:",this.settings),!l(this.settings.siteList))return void console.log("[Blur Focus] このサイトでは無効です");this.setupMessageListener(),this.settings.isBlur&&this.activate(),this.setupKeyboardShortcut(),console.log("[Blur Focus] キーボードショートカットリスナーを設定しました")}catch(t){console.error("[Blur Focus] Initialization error:",t)}})}loadSettings(){return a(this,void 0,void 0,function*(){this.settings=yield this.storageManager.loadSettings(),this.updateTargetSelector()})}updateTargetSelector(){this.targetSelector=this.settings.targetElements.join(",")}activate(){this.isActive||(this.isActive=!0,this.styleInjector.injectStyles(this.settings.blurIntensity),this.applyBlurToExistingElements(),this.eventHandler.setupEventListeners(),this.mutationHandler.start(this.targetSelector))}deactivate(){this.isActive&&(this.isActive=!1,this.styleInjector.removeBlurFromAllElements(),this.eventHandler.removeEventListeners(),this.mutationHandler.stop(),this.styleInjector.removeStyles())}applyBlurToExistingElements(){this.targetSelector&&document.querySelectorAll(this.targetSelector).forEach(t=>{this.styleInjector.applyBlurToElement(t)})}setupMessageListener(){chrome.runtime.onMessage.addListener((t,e,s)=>{if("toggleBlur"===t.action||"updateSettings"===t.action)return this.handleSettingsUpdate(t.settings||{}).then(()=>{s({success:!0})}).catch(t=>{console.error("[Blur Focus] Settings update error:",t),s({success:!1,error:t.message})}),!0})}handleSettingsUpdate(t){return a(this,void 0,void 0,function*(){this.settings=Object.assign(Object.assign({},this.settings),t),this.updateTargetSelector(),l(this.settings.siteList)&&this.settings.isBlur?(this.isActive&&this.deactivate(),this.activate()):this.deactivate()})}setupKeyboardShortcut(){document.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&t.shiftKey&&"f"===t.key.toLowerCase()&&(t.preventDefault(),this.toggleBlur())})}toggleBlur(){return a(this,void 0,void 0,function*(){this.settings.isBlur=!this.settings.isBlur;try{yield this.storageManager.saveSettings({isBlur:this.settings.isBlur}),this.settings.isBlur?this.activate():this.deactivate()}catch(t){console.error("[Blur Focus] Storage error:",t)}})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new c}):new c})();